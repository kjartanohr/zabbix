<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>/usr/share/zabbix/repo/default/scripts/fw_tab_percentage.pl.html</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v2">
<meta name="syntax" content="perl">
<meta name="settings" content="use_css,pre_wrap,no_foldcolumn,prevent_copy=">
<meta name="colorscheme" content="none">
<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
* { font-size: 1em; }
.Comment { color: #8080ff; }
.Constant { color: #ff6060; }
.Special { color: #ff40ff; }
.Identifier { color: #00ffff; }
.Statement { color: #ffff00; }
.PreProc { color: #ff40ff; }
-->
</style>

<script type='text/javascript'>
<!--

-->
</script>
</head>
<body>
<pre id='vimCodeElement'>
<span class="PreProc">#!/bin/perl</span>

<span class="Identifier">$debug</span>             = <span class="Constant">0</span>;

<span class="Comment">#Zabbix test that will have to print out zabbix test ok. If not, the script will not download</span>
<span class="Statement">if</span> (<span class="Identifier">$ARGV[</span><span class="Constant">0</span><span class="Identifier">]</span> <span class="Statement">eq</span> <span class="Constant">&quot;</span><span class="Constant">--zabbix-test-run</span><span class="Constant">&quot;</span>){
  <span class="Statement">print</span> <span class="Constant">&quot;</span><span class="Constant">ZABBIX TEST OK</span><span class="Constant">&quot;</span>;
  <span class="Statement">exit</span>;
}

<span class="Comment">#Exit if this is a mamagement</span>
<span class="Statement">if</span> (<span class="Statement">`</span><span class="Constant">cpprod_util CPPROD_IsMgmtMachine 2&gt;&amp;1</span><span class="Statement">`</span> =~ <span class="Statement">/</span><span class="Constant">1</span><span class="Statement">/</span>){
  debug(<span class="Constant">&quot;</span><span class="Constant">This is a MGMT, exit</span><span class="Constant">&quot;</span>);
  <span class="Statement">exit</span>;
}

debug(<span class="Constant">&quot;</span><span class="Identifier">$0</span><span class="Constant"> Input data </span><span class="Constant">&quot;</span>.<span class="Statement">join</span> <span class="Constant">&quot;</span><span class="Constant"> </span><span class="Constant">&quot;</span>,<span class="Identifier">@ARGV</span>);

<span class="Identifier">$vsid</span>              = <span class="Statement">shift</span> <span class="Identifier">@ARGV</span> || <span class="Constant">0</span>;                                     <span class="Comment">#VSID </span>
<span class="Identifier">$percentage_alert</span>  = <span class="Statement">shift</span> <span class="Identifier">@ARGV</span> || <span class="Constant">50</span>;                                    <span class="Comment">#Print tables that are more than N</span>
<span class="Identifier">$read_log</span>          = <span class="Statement">shift</span> <span class="Identifier">@ARGV</span> || <span class="Constant">0</span>;                                     <span class="Comment">#If this is defined, it will print the last log and exit</span>
<span class="Identifier">$log_file</span>          = <span class="Statement">shift</span> <span class="Identifier">@ARGV</span> || <span class="Constant">&quot;</span><span class="Constant">/tmp/zabbix/fw_tab/fw_tab_vs</span><span class="Identifier">$vsid</span><span class="Constant">&quot;</span>;   <span class="Comment">#What log file to use</span>
(<span class="Identifier">$log_dir</span>)         = <span class="Identifier">$log_file</span> =~ <span class="Statement">/</span><span class="Special">(.*)</span><span class="Special">\/</span><span class="Statement">/</span>;                                <span class="Comment">#Extract directory from log file path</span>

debug(<span class="Constant">&quot;</span><span class="Constant">This will run on VSID </span><span class="Identifier">$vsid</span><span class="Special">\n</span><span class="Identifier">$output</span><span class="Constant"> tables with more than </span><span class="Identifier">$percentage_alert</span><span class="Constant"> in use</span><span class="Special">\n</span><span class="Constant">Write to log file </span><span class="Identifier">$log_file</span><span class="Constant">&quot;</span>);
debug(<span class="Constant">&quot;</span><span class="Constant">This will not run a new fw tab check. It will only output from log file</span><span class="Constant">&quot;</span>) <span class="Statement">if</span> <span class="Identifier">$read_log</span>;

<span class="Comment">#Create zabbix tmp directory</span>
<span class="Statement">system</span> <span class="Constant">&quot;</span><span class="Constant">mkdir -p </span><span class="Identifier">$log_dir</span><span class="Constant">&quot;</span> <span class="Statement">unless</span> <span class="Statement">-d</span> <span class="Identifier">$log_dir</span>;

<span class="Comment">#If there a log file, print it</span>
<span class="Statement">if</span> (<span class="Statement">-f</span> <span class="Identifier">$log_file</span>) {
  debug(<span class="Constant">&quot;</span><span class="Constant">Log file found. Will read and output data</span><span class="Constant">&quot;</span>);
  <span class="Statement">foreach</span> (<span class="Statement">`</span><span class="Constant">cat </span><span class="Identifier">$log_file</span><span class="Statement">`</span>){
    (<span class="Identifier">$name</span>,<span class="Identifier">$percentage</span>) = <span class="Statement">split</span><span class="Statement">/</span><span class="Constant">: </span><span class="Statement">/</span>;
    <span class="Identifier">$percentage</span> =~ <span class="Statement">s/</span><span class="Constant">%</span><span class="Statement">//</span>;

    <span class="Statement">next</span> <span class="Statement">if</span> <span class="Identifier">$percentage</span> &lt; <span class="Identifier">$percentage_alert</span>;
    <span class="Statement">print</span>;
  }
}

<span class="Comment">#Exit the script if this is running for the old log output only</span>
<span class="Statement">if</span> (<span class="Identifier">$read_log</span>){
  debug(<span class="Constant">&quot;</span><span class="Constant">The script is started in read log file only mode. Exit</span><span class="Constant">&quot;</span>);
  <span class="Statement">exit</span>;
}

<span class="Comment">#fork a child and exit the parent</span>
<span class="Comment">#This script can run for minutes, so we need to fork the rest of the script. It will run in the background</span>
<span class="Comment">#Don't fork if debug is running. </span>
<span class="Statement">unless</span> (<span class="Identifier">$debug</span>){
  <span class="Statement">fork</span> &amp;&amp; <span class="Statement">exit</span>;
}

<span class="Comment">#Eveything after here is the child</span>

<span class="Comment">#Open log file</span>
<span class="Statement">open</span> <span class="Identifier">$fh_w</span>,<span class="Constant">&quot;</span><span class="Constant">&gt;</span><span class="Constant">&quot;</span>, <span class="Identifier">$log_file</span> <span class="Statement">or</span> <span class="Statement">die</span> <span class="Constant">&quot;</span><span class="Constant">Can't write to </span><span class="Identifier">$log_file</span><span class="Constant">: </span><span class="Identifier">$!</span><span class="Constant">&quot;</span>;

<span class="Comment">#Closing so the parent can exit and the child can live on</span>
<span class="Comment">#The parent will live and wait for the child if there is no close </span>
<span class="Comment">#Don't close if debug is running. </span>
<span class="Statement">unless</span> (<span class="Identifier">$debug</span>) {
  <span class="Statement">close</span> <span class="Identifier">STDOUT</span>;
  <span class="Statement">close</span> <span class="Identifier">STDIN</span>;
  <span class="Statement">close</span> <span class="Identifier">STDERR</span>;
}

<span class="Comment">#Listing all the local kernel tables</span>
<span class="Statement">foreach</span> (<span class="Statement">`</span><span class="Constant">source /etc/profile.d/vsenv.sh; vsenv </span><span class="Identifier">$vsid</span><span class="Constant"> &amp;&gt;/dev/null &amp;&amp; fw tab -s</span><span class="Statement">`</span>){
  <span class="Statement">next</span> <span class="Statement">unless</span> <span class="Statement">/</span><span class="Constant">localhost</span><span class="Statement">/</span>;
  <span class="Statement">chomp</span>;
  debug(<span class="Constant">&quot;</span><span class="Constant">foreach fw tab -s </span><span class="Identifier">$_</span><span class="Constant">&quot;</span>);

  <span class="Comment">#Split the output and insert the data in variables</span>
  (<span class="Identifier">$host</span>,<span class="Identifier">$name</span>,<span class="Identifier">$id</span>,<span class="Identifier">$vals</span>,<span class="Identifier">$peak</span>,<span class="Identifier">$slinks</span>) = <span class="Statement">split</span><span class="Statement">/</span><span class="Special">\s</span><span class="Special">{1,}</span><span class="Statement">/</span>;

  <span class="Comment">#Skip if peak is 0</span>
  <span class="Statement">if</span> (<span class="Identifier">$peak</span> &lt; <span class="Constant">10</span>){
    debug(<span class="Constant">&quot;</span><span class="Constant">Peak is 10, skip</span><span class="Constant">&quot;</span>);
    <span class="Statement">next</span>;
  }

  <span class="Comment">#Run the fw tab command and save the output to this variable</span>
  <span class="Identifier">$fw_tab_cmd</span> = <span class="Constant">&quot;</span><span class="Constant">source /etc/profile.d/vsenv.sh; vsenv </span><span class="Identifier">$vsid</span><span class="Constant"> &amp;&gt;/dev/null &amp;&amp; fw tab -t </span><span class="Identifier">$name</span><span class="Constant"> -m 1 2&gt;&amp;1</span><span class="Constant">&quot;</span>;
  <span class="Identifier">$fw_tab_out</span> = <span class="Statement">`</span><span class="Identifier">$fw_tab_cmd</span><span class="Statement">`</span>;

  debug(<span class="Constant">&quot;</span><span class="Constant">cmd: </span><span class="Identifier">$fw_tab_cmd</span><span class="Constant">&quot;</span>);
  debug(<span class="Constant">&quot;</span><span class="Constant">out: </span><span class="Identifier">$fw_tab_out</span><span class="Constant">&quot;</span>);

  <span class="Comment">#Get table limit, max values</span>
  (<span class="Identifier">$limit</span>) = <span class="Identifier">$fw_tab_out</span> =~ <span class="Statement">/</span><span class="Constant"> limit </span><span class="Special">(</span><span class="Special">\d</span><span class="Special">{1,})</span><span class="Statement">/</span>;

  <span class="Comment">#Skip if not limit found</span>
  <span class="Statement">unless</span> (<span class="Identifier">$limit</span> =~ <span class="Statement">/</span><span class="Special">\d</span><span class="Statement">/</span>) {
    debug(<span class="Constant">&quot;</span><span class="Constant">Could not find a limit. Skipping</span><span class="Constant">&quot;</span>);
    <span class="Statement">next</span>;
  }
  debug(<span class="Constant">&quot;</span><span class="Constant">Found limit </span><span class="Identifier">$limit</span><span class="Constant">&quot;</span>);

  <span class="Comment">#Get table entry count</span>
  (<span class="Identifier">$count</span>) = <span class="Identifier">$fw_tab_out</span> =~ <span class="Statement">/</span><span class="Constant"> num ents </span><span class="Special">(</span><span class="Special">\d</span><span class="Special">{1,})</span><span class="Statement">/</span>;

  <span class="Comment">#Skip table unless entry count found</span>
  <span class="Statement">unless</span> (<span class="Identifier">$count</span> =~ <span class="Statement">/</span><span class="Special">\d</span><span class="Statement">/</span>) {
    debug(<span class="Constant">&quot;</span><span class="Constant">Could not find an entry count. Skipping</span><span class="Constant">&quot;</span>);
    <span class="Statement">next</span>;
  }
  debug(<span class="Constant">&quot;</span><span class="Constant">Found table count </span><span class="Identifier">$count</span><span class="Constant">&quot;</span>);

  <span class="Comment">#Skip if entry $count is 0</span>
  <span class="Statement">if</span> (<span class="Identifier">$count</span> == <span class="Constant">0</span>){
    debug(<span class="Constant">&quot;</span><span class="Constant">Entry count is 0. Skipping</span><span class="Constant">&quot;</span>);
    <span class="Statement">next</span>;
  }

  <span class="Comment">#Calculate the percentage</span>
  <span class="Identifier">$in_use_percentage</span> = <span class="Statement">int</span> (<span class="Identifier">$count</span> / <span class="Identifier">$limit</span> * <span class="Constant">100</span>);

  <span class="Comment">#Print the name and percentage to the log file</span>
  <span class="Statement">print</span> <span class="Identifier">$fh_w</span> <span class="Constant">&quot;</span><span class="Identifier">$name</span><span class="Constant">: </span><span class="Identifier">$in_use_percentage</span><span class="Constant">%</span><span class="Special">\n</span><span class="Constant">&quot;</span>;
  debug(<span class="Constant">&quot;</span><span class="Identifier">$name</span><span class="Constant">: </span><span class="Identifier">$in_use_percentage</span><span class="Constant">%</span><span class="Special">\n</span><span class="Constant">&quot;</span>);

}

<span class="Statement">sub </span><span class="Identifier">debug </span>{
  <span class="Statement">print</span> <span class="Constant">&quot;</span><span class="Constant">DEBUG: </span><span class="Identifier">$_[</span><span class="Constant">0</span><span class="Identifier">]</span><span class="Special">\n</span><span class="Constant">&quot;</span> <span class="Statement">if</span> <span class="Identifier">$debug</span>;
}
</pre>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
